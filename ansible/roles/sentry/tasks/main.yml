- name: Install virtualenv
  sudo: yes
  pip: name=virtualenv

- name: Install Sentry and create virtualenv if needed
  sudo: yes
  pip:
    name: sentry
    virtualenv: /www/sentry/
    virtualenv_site_packages: no

- name: Install Sentry[postgres] and create virtualenv if needed
  sudo: yes
  pip:
    name: sentry[postgres]
    virtualenv: /www/sentry/
    virtualenv_site_packages: no

- name: Initialize Sentry config
  sudo: yes
  command: /www/sentry/bin/sentry init /etc/sentry.conf.py

- name: Change Sentry config
  sudo: yes
  template: src={{ sentry.template }} dest=/etc/sentry.conf.py owner=root group=root mode=644

- name: Upgrade Sentry schema
  sudo: yes
  command: /www/sentry/bin/sentry --config=/etc/sentry.conf.py upgrade

- name: Create Sentry superuser
  sudo: yes
  command: /www/sentry/bin/sentry --config=/etc/sentry.conf.py createuser --email=sentry@sentry.com --superuser --no-password --no-input

- name: Set cron to cleanup Sentry
  cron: name="Cleanup sentry" minute="0" hour="3" job="/www/sentry/bin/sentry cleanup --days=30"